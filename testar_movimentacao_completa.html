<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Auditoria de Movimenta√ß√£o Completa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Teste Completo - Auditoria de Movimenta√ß√£o</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã Teste de Movimenta√ß√£o</h5>
                    </div>
                    <div class="card-body">
                        <button id="btnTestarMovimento" class="btn btn-primary">
                            üîÑ Testar Movimenta√ß√£o com Auditoria
                        </button>
                        
                        <div id="resultadoTeste" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>üìä √öltimas Movimenta√ß√µes</h5>
                    </div>
                    <div class="card-body">
                        <button id="btnVerAuditoria" class="btn btn-secondary">
                            üîç Ver Auditoria de Movimenta√ß√µes
                        </button>
                        
                        <div id="auditoriaResultados" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìù Log de Testes</h5>
                    </div>
                    <div class="card-body">
                        <div id="logContainer" style="height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                            <div class="text-success">‚úÖ Sistema de testes carregado</div>
                            <div class="text-info">‚ÑπÔ∏è Pronto para testar movimenta√ß√µes</div>
                        </div>
                        
                        <button id="btnLimparLog" class="btn btn-sm btn-outline-secondary mt-2">
                            üßπ Limpar Log
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5>üìù O que est√° sendo testado:</h5>
                    <ul class="mb-0">
                        <li><strong>Backend PHP:</strong> Captura completa de dados antes/depois da movimenta√ß√£o</li>
                        <li><strong>Sistema de Auditoria:</strong> Registro detalhado com 31 campos expandidos</li>
                        <li><strong>Frontend JavaScript:</strong> Logs detalhados no console do navegador</li>
                        <li><strong>Rastreamento:</strong> IP, usu√°rio, browser, tempo de execu√ß√£o, transa√ß√£o √∫nica</li>
                        <li><strong>Dados Espec√≠ficos:</strong> Paciente, conv√™nio, exames, hor√°rios origem/destino</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logContainer;
        
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            
            // Interceptar logs do console para mostrar na interface
            const originalLog = console.log;
            const originalError = console.error;
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                adicionarLog('INFO', args.join(' '), 'text-info');
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                adicionarLog('ERROR', args.join(' '), 'text-danger');
            };
            
            // Event listeners
            document.getElementById('btnTestarMovimento').addEventListener('click', testarMovimentacao);
            document.getElementById('btnVerAuditoria').addEventListener('click', buscarAuditoria);
            document.getElementById('btnLimparLog').addEventListener('click', limparLog);
        });

        function adicionarLog(tipo, mensagem, classe) {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = classe;
            div.innerHTML = `[${timestamp}] ${tipo}: ${mensagem}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function testarMovimentacao() {
            const btn = document.getElementById('btnTestarMovimento');
            const resultado = document.getElementById('resultadoTeste');
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Testando...';
            resultado.innerHTML = '';
            
            try {
                adicionarLog('TEST', 'Iniciando teste de movimenta√ß√£o...', 'text-primary');
                
                // Simular dados de movimenta√ß√£o
                const dadosMovimento = {
                    agendamento_id: 151, // ID que sabemos que existe
                    nova_data: '2025-08-17',
                    nova_hora: '10:30'
                };
                
                adicionarLog('TEST', `Movendo agendamento ${dadosMovimento.agendamento_id} para ${dadosMovimento.nova_data} ${dadosMovimento.nova_hora}`, 'text-info');
                
                const response = await fetch('mover_agendamento.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosMovimento)
                });
                
                const data = await response.json();
                
                if (data.status === 'sucesso') {
                    adicionarLog('SUCCESS', 'Movimenta√ß√£o realizada com sucesso!', 'text-success');
                    adicionarLog('AUDIT', `Auditoria registrada: ${data.detalhes.auditoria_registrada}`, 'text-success');
                    
                    resultado.innerHTML = `
                        <div class="alert alert-success">
                            <h6>‚úÖ Teste Realizado com Sucesso</h6>
                            <p><strong>Paciente:</strong> ${data.detalhes.paciente}</p>
                            <p><strong>De:</strong> ${data.detalhes.horario_anterior}</p>
                            <p><strong>Para:</strong> ${data.detalhes.horario_novo}</p>
                            <p><strong>Usu√°rio:</strong> ${data.detalhes.usuario}</p>
                            <p><strong>Auditoria:</strong> ${data.detalhes.auditoria_registrada === 'sim' ? '‚úÖ Registrada' : '‚ùå Falhou'}</p>
                        </div>
                    `;
                } else {
                    adicionarLog('ERROR', `Falha na movimenta√ß√£o: ${data.mensagem}`, 'text-danger');
                    
                    resultado.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>‚ùå Falha no Teste</h6>
                            <p>${data.mensagem}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                adicionarLog('ERROR', `Erro na requisi√ß√£o: ${error.message}`, 'text-danger');
                
                resultado.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>üí• Erro de Rede</h6>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Testar Movimenta√ß√£o com Auditoria';
            }
        }

        async function buscarAuditoria() {
            const btn = document.getElementById('btnVerAuditoria');
            const resultado = document.getElementById('auditoriaResultados');
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Carregando...';
            resultado.innerHTML = '';
            
            try {
                adicionarLog('AUDIT', 'Buscando registros de auditoria...', 'text-primary');
                
                const response = await fetch('consultar_auditoria.php?limit=5&acao=MOVER');
                const data = await response.json();
                
                if (data.status === 'sucesso') {
                    adicionarLog('AUDIT', `Encontrados ${data.total_registros} registros de movimenta√ß√£o`, 'text-success');
                    
                    let html = `
                        <div class="alert alert-info">
                            <h6>üìä √öltimas Movimenta√ß√µes (${data.total_registros})</h6>
                        </div>
                    `;
                    
                    data.historico.forEach((item, index) => {
                        html += `
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <h6 class="card-title">üîÑ Movimenta√ß√£o #${item.ID}</h6>
                                    <p class="card-text">
                                        <strong>Paciente:</strong> ${item.PACIENTE_NOME}<br>
                                        <strong>Data:</strong> ${item.DATA_ACAO}<br>
                                        <strong>Usu√°rio:</strong> ${item.USUARIO}<br>
                                        <strong>IP:</strong> ${item.IP_USUARIO}
                                    </p>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultado.innerHTML = html;
                } else {
                    adicionarLog('ERROR', 'Falha ao buscar auditoria', 'text-danger');
                    resultado.innerHTML = '<div class="alert alert-warning">Nenhum registro encontrado</div>';
                }
                
            } catch (error) {
                adicionarLog('ERROR', `Erro ao buscar auditoria: ${error.message}`, 'text-danger');
                resultado.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Ver Auditoria de Movimenta√ß√µes';
            }
        }

        function limparLog() {
            logContainer.innerHTML = '<div class="text-success">‚úÖ Log limpo</div>';
        }
    </script>
</body>
</html>