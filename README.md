# API Sistema de Agendamento - Cl√≠nica Oitava Rosado

## üöÄ Vis√£o Geral

API REST completa para gerenciamento de agendamentos m√©dicos, desenvolvida em PHP com banco de dados Firebird. Sistema otimizado para **Agentes de IA** com endpoints inteligentes e automa√ß√µes avan√ßadas.

**üåê URL Base:** `http://sistema.clinicaoitavarosado.com.br/oitava/agenda/`

## ‚ú® Funcionalidades Principais

### üè• **Sistema de Agendamento**
- ‚úÖ Consultas m√©dicas por especialidade
- ‚úÖ Procedimentos e exames com preparos
- ‚úÖ Controle de vagas por dia da semana
- ‚úÖ Sistema de encaixes inteligente
- ‚úÖ Reagendamentos e cancelamentos

### üë• **Gest√£o de Pacientes**
- ‚úÖ Cadastro completo de pacientes
- ‚úÖ Busca por nome, CPF ou data nascimento
- ‚úÖ Hist√≥rico completo de agendamentos
- ‚úÖ Valida√ß√µes autom√°ticas

### ü§ñ **Otimizado para Agentes de IA**
- ‚úÖ **7 novos endpoints** espec√≠ficos para IA
- ‚úÖ Dados estruturados em JSON
- ‚úÖ Valida√ß√µes robustas
- ‚úÖ Notifica√ß√µes autom√°ticas
- ‚úÖ Auditoria completa

## üîê Autentica√ß√£o

Sistema de **Bearer Token** com validade de 1 ano:

```bash
curl -X POST "/auth/token.php" \
  -H "Content-Type: application/json" \
  -d '{"client_name":"Meu App","client_email":"contato@app.com"}'
```

**Token de teste:** `OWY2NGE0YTQtNGQ0MS00ZjVkLWI3ZTUtOGY2ZDZhNGE0YTQ0`

---

## üÜï **ENDPOINTS PARA AGENTES DE IA**

> **‚úÖ CORRE√á√ïES APLICADAS EM 06/10/2025:**
> - **Autentica√ß√£o corrigida** em `consultar_unidades.php`, `cadastrar_paciente.php` e `consultar_agendamentos_paciente.php`
> - Fun√ß√£o `verify_api_token()` refatorada para retornar array com status
> - Mensagens de erro de autentica√ß√£o mais descritivas
> - Bearer Token funcionando corretamente em todos os 3 endpoints
>
> **‚úÖ CORRE√á√ïES APLICADAS EM 04/10/2025:**
> - Todos endpoints agora incluem `ibase_commit()` e `ibase_rollback()`
> - Valida√ß√£o de resultados de queries implementada
> - Tratamento de erros aprimorado
> - Transa√ß√µes Firebird gerenciadas corretamente

### 1. üí∞ **Consultar Pre√ßos**
`GET /consultar_precos.php`

Consulta valores por especialidade, procedimento e conv√™nio.

```bash
curl -H "Authorization: Bearer TOKEN" \
  "/consultar_precos.php?especialidade_id=1&convenio_id=24"
```

**Resposta:**
```json
{
  "status": "sucesso",
  "total_precos": 1,
  "precos": [{
    "especialidade_nome": "Cardiologia",
    "convenio_nome": "Amil",
    "valor_consulta": 150.00,
    "valor_retorno": 80.00
  }]
}
```

---

### 2. üë§ **Cadastrar Paciente** ‚úÖ AUTENTICA√á√ÉO CORRIGIDA
`POST /cadastrar_paciente.php`

Cadastro completo de novos pacientes com valida√ß√µes. **Autentica√ß√£o via Bearer Token funcionando corretamente.**

**Campos obrigat√≥rios:**
- `nome`: Nome completo
- `data_nascimento`: Formato YYYY-MM-DD
- `telefone`: Telefone de contato

**Campos opcionais:**
- `cpf`, `email`, `endereco`, `cep`, `cidade`, `estado`, `rg`, `sexo`, `profissao`, `estado_civil`

```bash
curl -X POST -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  "/cadastrar_paciente.php" \
  -d '{
    "nome": "Jo√£o Silva",
    "cpf": "123.456.789-01",
    "data_nascimento": "1990-01-01",
    "telefone": "(84) 99999-9999",
    "email": "joao@email.com"
  }'
```

**Resposta:**
```json
{
  "status": "sucesso",
  "message": "Paciente cadastrado com sucesso",
  "paciente": {
    "id": 622690,
    "nome": "Jo√£o Silva",
    "cpf": "123.456.789-01",
    "data_cadastro": "2025-10-04 14:30:00"
  }
}
```

---

### 3. üè• **Consultar Unidades** ‚úÖ AUTENTICA√á√ÉO CORRIGIDA
`GET /consultar_unidades.php`

Informa√ß√µes completas das unidades com especialidades e m√©dicos. **Autentica√ß√£o via Bearer Token funcionando corretamente.**

**Par√¢metros:**
- `unidade_id` (opcional): ID espec√≠fico da unidade
- `ativa_apenas` (opcional): Apenas ativas (default: true)

```bash
curl -H "Authorization: Bearer TOKEN" \
  "/consultar_unidades.php?unidade_id=1"
```

**Resposta:**
```json
{
  "status": "sucesso",
  "unidade": {
    "id": 1,
    "nome": "Mossor√≥",
    "endereco": "Rua Principal, 123",
    "telefone": "(84) 3421-1234",
    "servicos": {
      "especialidades": [
        {"id": 1, "nome": "Cardiologia"},
        {"id": 2, "nome": "Dermatologia"}
      ],
      "total_especialidades": 2
    },
    "horario_funcionamento": {
      "por_dia": {
        "SEGUNDA": [{"inicio": "07:00", "fim": "17:00"}]
      }
    }
  }
}
```

---

### 4. üìã **Consultar Preparos**
`GET /consultar_preparos.php`

Instru√ß√µes de preparos por exame ou procedimento.

```bash
curl -H "Authorization: Bearer TOKEN" \
  "/consultar_preparos.php?procedimento_id=34"
```

**Resposta:**
```json
{
  "status": "sucesso",
  "total_preparos": 1,
  "preparos": [{
    "exame_nome": "Resson√¢ncia Magn√©tica",
    "titulo": "Preparo para RM",
    "instrucoes": [
      "Jejum de 4 horas",
      "Retirar objetos met√°licos"
    ],
    "tempo_jejum_horas": 4,
    "anexos": [
      {"nome": "orientacoes.pdf", "url_download": "..."}
    ]
  }]
}
```

---

### 5. üìÖ **Agendamentos por Paciente** ‚úÖ AUTENTICA√á√ÉO CORRIGIDA
`GET /consultar_agendamentos_paciente.php`

Hist√≥rico completo com a√ß√µes permitidas. **Autentica√ß√£o via Bearer Token funcionando corretamente.**

**Par√¢metros:**
- `paciente_id` ou `cpf`: Obrigat√≥rio (um dos dois)
- `status` (opcional): Filtrar por status
- `data_inicio` (opcional): Data inicial YYYY-MM-DD
- `data_fim` (opcional): Data final YYYY-MM-DD
- `limite` (opcional): Limite de registros (default: 50)

```bash
curl -H "Authorization: Bearer TOKEN" \
  "/consultar_agendamentos_paciente.php?paciente_id=1&status=AGENDADO"
```

**Resposta:**
```json
{
  "status": "sucesso",
  "paciente": {
    "id": 1,
    "nome": "Jo√£o Silva",
    "cpf": "123.456.789-01"
  },
  "total_agendamentos": 2,
  "filtros_aplicados": {
    "paciente_id": 1,
    "status": "AGENDADO",
    "limite": 50
  },
  "agendamentos": [{
    "id": 123,
    "numero": 2415001,
    "data": "2025-09-10",
    "horario": "08:00",
    "status": "AGENDADO",
    "especialidade": {"nome": "Cardiologia"},
    "unidade": {"nome": "Mossor√≥"},
    "exames": [],
    "ordem_servico": {
      "tem_os": false,
      "numero": null
    },
    "acoes_permitidas": {
      "pode_cancelar": true,
      "pode_reagendar": true,
      "pode_confirmar": true
    }
  }]
}
```

---

### 6. üö´ **Processar No-Show**
`POST /processar_noshow.php`

Registra falta com notifica√ß√µes autom√°ticas.

```bash
curl -X POST -H "Authorization: Bearer TOKEN" \
  "/processar_noshow.php" \
  -d '{
    "agendamento_id": 123,
    "observacao": "Paciente n√£o compareceu",
    "enviar_notificacao": true,
    "usuario": "RECEPCAO"
  }'
```

**Resposta:**
```json
{
  "status": "sucesso",
  "message": "No-show registrado com sucesso",
  "agendamento": {
    "numero": 2415001,
    "status_anterior": "AGENDADO",
    "status_atual": "FALTOU"
  },
  "notificacoes": {
    "total_enviadas": 3,
    "enviadas": [
      {"tipo": "whatsapp_equipe", "status": "enviado"},
      {"tipo": "email_equipe", "status": "enviado"}
    ]
  }
}
```

---

### 7. üíµ **Consultar Valores OS**
`GET /consultar_valores_os.php`

Valores para cria√ß√£o de Ordem de Servi√ßo.

```bash
curl -H "Authorization: Bearer TOKEN" \
  "/consultar_valores_os.php?convenio_id=24&exames_ids=31,32"
```

**Resposta:**
```json
{
  "status": "sucesso",
  "convenio": {"nome": "Amil"},
  "resumo": {
    "valor_total_geral": 350.50,
    "itens_com_valor": 2,
    "itens_sem_cobertura": 0
  },
  "valores": [{
    "tipo": "exame",
    "exame_id": 31,
    "nome": "Resson√¢ncia Magn√©tica - Cr√¢nio",
    "valor_unitario": 250.00,
    "coberto_convenio": true,
    "pode_adicionar": true
  }]
}
```

---

## üìö **ENDPOINTS PRINCIPAIS**

### **Buscar Dados**
- `GET /buscar_especialidades.php?busca=cardio`
- `GET /buscar_medicos.php?busca=jo√£o`
- `GET /buscar_convenios.php?busca=amil`
- `POST /buscar_paciente.php` - `{"termo": "Jo√£o Silva"}`

### **Agendar**
- `GET /listar_agendas.php?tipo=consulta&nome=cardiologia`
- `GET /buscar_horarios.php?agenda_id=1&data=2025-09-10`
- `GET /verificar_vagas.php?agenda_id=1&data=2025-09-10&convenio_id=24`
- `POST /processar_agendamento.php`

### **Gerenciar**
- `GET /buscar_agendamentos_dia.php?agenda_id=1&data=2025-09-10`
- `GET /buscar_agendamento.php?id=123`
- `POST /cancelar_agendamento.php`
- `POST /atualizar_status_agendamento.php`

---

## üîÑ **FLUXO COMPLETO PARA IA**

### **1. Consulta ‚Üí Agendamento**
```bash
# 1. Buscar especialidades
GET /buscar_especialidades.php?busca=cardio

# 2. Listar agendas dispon√≠veis
GET /listar_agendas.php?tipo=consulta&nome=cardiologia

# 3. Verificar pre√ßos
GET /consultar_precos.php?especialidade_id=1&convenio_id=24

# 4. Verificar hor√°rios
GET /buscar_horarios.php?agenda_id=1&data=2025-09-10

# 5. Buscar/Cadastrar paciente
POST /buscar_paciente.php
# OU
POST /cadastrar_paciente.php

# 6. Criar agendamento
POST /processar_agendamento.php
```

### **2. Procedimento ‚Üí Agendamento**
```bash
# 1. Consultar preparos
GET /consultar_preparos.php?procedimento_id=34

# 2. Consultar valores
GET /consultar_valores_os.php?convenio_id=24&procedimento_id=34

# 3. Listar agendas de procedimento
GET /listar_agendas.php?tipo=procedimento&nome=Resson√¢ncia

# 4. Criar agendamento com exames
POST /processar_agendamento.php
```

---

## ü§ñ **RECURSOS PARA IA**

### **Valida√ß√µes Autom√°ticas:**
- ‚úÖ **CPF duplicado** - Verifica√ß√£o autom√°tica
- ‚úÖ **Cobertura conv√™nio** - Valida√ß√£o em tempo real
- ‚úÖ **Disponibilidade hor√°rio** - Controle de conflitos
- ‚úÖ **Limite de vagas** - Por dia da semana

### **Notifica√ß√µes Autom√°ticas:**
- üì± **WhatsApp** - Lembretes e confirma√ß√µes
- üìß **Email** - Notifica√ß√µes para equipe
- üö® **No-Show** - Alertas autom√°ticos

### **Auditoria Completa:**
- üìù **Todas as opera√ß√µes** registradas
- üë§ **Usu√°rio e timestamp** em cada a√ß√£o
- üîç **Hist√≥rico detalhado** por agendamento
- üìä **Relat√≥rios** de atividades

---

## ‚ö†Ô∏è **C√ìDIGOS DE ERRO**

| C√≥digo | Descri√ß√£o |
|--------|-----------|
| 200 | ‚úÖ Sucesso |
| 400 | ‚ùå Par√¢metros inv√°lidos |
| 401 | üîí Token inv√°lido/expirado |
| 404 | üîç Recurso n√£o encontrado |
| 409 | ‚ö° Conflito (ex: CPF duplicado) |
| 500 | üî• Erro interno |

---

## üõ†Ô∏è **CONFIGURA√á√ÉO**

### **Requisitos:**
- PHP 7.4+
- Firebird 3.0+
- Extens√µes: `php-firebird`, `php-json`, `php-mbstring`

### **Instala√ß√£o:**
```bash
git clone [repositorio]
cd agenda
cp includes/connection.php.example includes/connection.php
# Configurar banco de dados
```

### **WhatsApp (Opcional):**
```bash
./whatsapp_setup.sh
# Configura Evolution API
```

---

## üìà **PERFORMANCE**

### **Otimiza√ß√µes:**
- üöÄ **Queries otimizadas** com √≠ndices
- üì¶ **Respostas JSON UTF-8**
- üîÑ **Transa√ß√µes Firebird** com commit/rollback
- üìä **Logs estruturados** para monitoramento
- ‚úÖ **Valida√ß√µes de resultado** em todas queries

---

## üîí **SEGURAN√áA**

- üõ°Ô∏è **Autentica√ß√£o Bearer Token** (1 ano validade)
- üîê **Sanitiza√ß√£o SQL** com prepared statements
- üìù **Auditoria** de todas as opera√ß√µes
- üîç **Valida√ß√£o** rigorosa de entrada
- ‚úÖ **Transa√ß√µes** com commit/rollback autom√°tico
- üö® **Error handling** robusto

---

## üìû **SUPORTE**

- üìß **Email:** suporte@clinicaoitavarosado.com.br
- üì± **WhatsApp:** (84) 99999-9999
- üìö **Documenta√ß√£o:** Ver `API_DOCUMENTATION.md`

---

## üìÑ **LICEN√áA**

Propriedade da **Cl√≠nica Oitava Rosado** - Todos os direitos reservados.

**Vers√£o:** 2.2
**√öltima atualiza√ß√£o:** 06 Outubro 2025

---

## üìù **CHANGELOG**

### **v2.2** - 06/10/2025
- ‚úÖ **Corre√ß√£o cr√≠tica:** Autentica√ß√£o corrigida em 3 endpoints principais
- ‚úÖ **Corre√ß√£o:** `verify_api_token()` - Fun√ß√£o renomeada e refatorada
- ‚úÖ **Corre√ß√£o:** `consultar_unidades.php` - Autentica√ß√£o funcionando
- ‚úÖ **Corre√ß√£o:** `cadastrar_paciente.php` - Autentica√ß√£o funcionando
- ‚úÖ **Corre√ß√£o:** `consultar_agendamentos_paciente.php` - Autentica√ß√£o funcionando
- ‚úÖ **Melhoria:** Mensagens de erro mais descritivas para autentica√ß√£o

### **v2.1** - 04/10/2025
- ‚úÖ **Corre√ß√£o cr√≠tica:** Adicionado `ibase_commit()` em todos endpoints
- ‚úÖ **Corre√ß√£o cr√≠tica:** Adicionado `ibase_rollback()` no tratamento de erros
- ‚úÖ **Melhoria:** Valida√ß√£o de resultados de queries
- ‚úÖ **Corre√ß√£o:** `consultar_unidades.php` - Transa√ß√µes corrigidas
- ‚úÖ **Corre√ß√£o:** `cadastrar_paciente.php` - Commit ap√≥s inser√ß√£o
- ‚úÖ **Corre√ß√£o:** `consultar_agendamentos_paciente.php` - Transa√ß√µes gerenciadas

### **v2.0** - Setembro 2025
- üéâ **7 novos endpoints** espec√≠ficos para Agentes de IA
- ü§ñ Otimiza√ß√µes para integra√ß√£o com IA
- üìù Auditoria expandida
- üì± Notifica√ß√µes WhatsApp

### **v1.0** - Agosto 2025
- üöÄ Vers√£o inicial da API
- üìÖ Sistema de agendamento completo
- üè• Suporte consultas e procedimentos

---

ü§ñ **Sistema otimizado para Agentes de IA com automa√ß√µes inteligentes!**
